{% extends 'base.html' %}

{% block title %}Command Dashboard - KDF SENTINEL{% endblock %}

{% block content %}
<style>
    /* Professional Military Typography */
    :root {
        --kdf-navy: #0F2A4D;
        --kdf-blue: #1e40af;
        --kdf-green: #15803d;
        --kdf-gold: #D4AF37;
        --kdf-red: #DC2626;
        --gray-50: #f9fafb;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-700: #374151;
        --gray-900: #111827;
    }

    .dashboard-header {
        background: white;
        padding: 2rem;
        margin-bottom: 2rem;
        border-bottom: 4px solid var(--kdf-navy);
        border-radius: 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .dashboard-header h1 {
        margin: 0 0 0.5rem 0;
        font-size: 2rem;
        font-weight: 700;
        color: var(--kdf-navy);
        letter-spacing: -0.025em;
    }

    .dashboard-header p {
        margin: 0;
        color: var(--gray-700);
        font-size: 1rem;
        font-weight: 400;
        line-height: 1.5;
    }

    .dashboard-subtitle {
        color: var(--kdf-blue);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
    }

    /* Metrics Grid */
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2.5rem;
    }

    .metric-card {
        background: white;
        padding: 1.5rem;
        border: 1px solid var(--gray-200);
        border-radius: 4px;
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
    }

    .metric-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: var(--border-color);
    }

    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        border-color: var(--gray-300);
    }

    .metric-icon {
        width: 48px;
        height: 48px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        margin-bottom: 1rem;
        color: var(--icon-color);
        background: var(--icon-bg);
    }

    .metric-value {
        font-size: 2.25rem;
        font-weight: 700;
        margin: 0.5rem 0;
        color: var(--gray-900);
        font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    }

    .metric-label {
        color: var(--gray-700);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .metric-description {
        color: var(--gray-700);
        font-size: 0.875rem;
        line-height: 1.5;
        margin-top: 0.5rem;
    }

    /* Charts Grid */
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(480px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2.5rem;
    }

    .chart-card {
        background: white;
        padding: 1.5rem;
        border: 1px solid var(--gray-200);
        border-radius: 4px;
        height: 100%;
    }

    .chart-card.full-width {
        grid-column: 1 / -1;
    }

    .chart-header {
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--gray-200);
    }

    .chart-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--gray-900);
        margin-bottom: 0.25rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .chart-title i {
        color: var(--title-color);
    }

    .chart-subtitle {
        color: var(--gray-700);
        font-size: 0.875rem;
        line-height: 1.5;
    }

    .chart-container {
        position: relative;
        height: 320px;
    }

    .chart-container.small {
        height: 280px;
    }

    /* Military Grade Visuals */
    .military-graph {
        position: relative;
        background: linear-gradient(135deg, var(--gray-50) 0%, white 100%);
    }

    .grid-lines {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: 
            linear-gradient(to right, var(--gray-200) 1px, transparent 1px),
            linear-gradient(to bottom, var(--gray-200) 1px, transparent 1px);
        background-size: 40px 40px;
        opacity: 0.3;
    }

    /* Data Table */
    .data-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin-top: 1rem;
        font-size: 0.875rem;
    }

    .data-table th {
        background: var(--gray-50);
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        color: var(--gray-700);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-bottom: 2px solid var(--gray-200);
    }

    .data-table td {
        padding: 1rem;
        border-bottom: 1px solid var(--gray-200);
        color: var(--gray-700);
    }

    .data-table tr:last-child td {
        border-bottom: none;
    }

    .data-table tr:hover {
        background: var(--gray-50);
    }

    /* Badges */
    .severity-badge,
    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }

    .severity-badge::before,
    .status-badge::before {
        content: '';
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: currentColor;
    }

    .severity-critical { background: #fee2e2; color: #991b1b; }
    .severity-high { background: #fed7aa; color: #9a3412; }
    .severity-medium { background: #fef3c7; color: #92400e; }
    .severity-low { background: #d1fae5; color: #065f46; }

    .status-active { background: #d1fae5; color: #065f46; }
    .status-planning { background: #e0e7ff; color: #3730a3; }
    .status-completed { background: #ddd6fe; color: #5b21b6; }

    /* Responsive */
    @media (max-width: 1200px) {
        .charts-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .metrics-grid {
            grid-template-columns: 1fr;
        }
        
        .chart-card {
            padding: 1rem;
        }
        
        .chart-container {
            height: 280px;
        }
        
        .chart-container.small {
            height: 240px;
        }
        
        .dashboard-header {
            padding: 1.5rem;
        }
        
        .dashboard-header h1 {
            font-size: 1.5rem;
        }
    }

    @media (max-width: 480px) {
        .charts-grid {
            grid-template-columns: 1fr;
        }
        
        .chart-card.full-width {
            grid-column: 1;
        }
        
        .metric-value {
            font-size: 1.875rem;
        }
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: var(--gray-700);
    }

    .empty-state i {
        font-size: 3rem;
        color: var(--gray-300);
        margin-bottom: 1rem;
    }
</style>

<!-- Dashboard Header -->
<div class="dashboard-header">
    <div class="dashboard-subtitle">Strategic Command Dashboard</div>
    <h1>Operational Intelligence Overview</h1>
    <p>Comprehensive situational awareness and real-time analytics for KDF command personnel. Last updated: {{ current_time|date:"F j, Y H:i"|default:"Now" }}</p>
</div>

<!-- Key Metrics Grid -->
<div class="metrics-grid">
    <div class="metric-card" style="--border-color: #1e40af; --icon-color: #1e40af; --icon-bg: #eff6ff;">
        <div class="metric-icon">
            <i class="bi bi-people-fill"></i>
        </div>
        <div class="metric-value">{{ total_personnel|default:"0" }}</div>
        <div class="metric-label">Active Personnel</div>
        <div class="metric-description">Across all branches and units</div>
    </div>

    <div class="metric-card" style="--border-color: #15803d; --icon-color: #15803d; --icon-bg: #f0fdf4;">
        <div class="metric-icon">
            <i class="bi bi-crosshair"></i>
        </div>
        <div class="metric-value">{{ active_missions|default:"0" }}</div>
        <div class="metric-label">Active Operations</div>
        <div class="metric-description">Currently deployed missions</div>
    </div>

    <div class="metric-card" style="--border-color: #DC2626; --icon-color: #DC2626; --icon-bg: #fef2f2;">
        <div class="metric-icon">
            <i class="bi bi-exclamation-triangle-fill"></i>
        </div>
        <div class="metric-value">{{ critical_threats|default:"0" }}</div>
        <div class="metric-label">Critical Threats</div>
        <div class="metric-description">Requiring immediate attention</div>
    </div>

    <div class="metric-card" style="--border-color: #D4AF37; --icon-color: #D4AF37; --icon-bg: #fefce8;">
        <div class="metric-icon">
            <i class="bi bi-cash-stack"></i>
        </div>
        <div class="metric-value">KES {{ total_budget_allocated|floatformat:0|default:"0" }}M</div>
        <div class="metric-label">Budget Allocated</div>
        <div class="metric-description">Active operations budget</div>
    </div>

    <div class="metric-card" style="--border-color: #7c3aed; --icon-color: #7c3aed; --icon-bg: #f5f3ff;">
        <div class="metric-icon">
            <i class="bi bi-cpu-fill"></i>
        </div>
        <div class="metric-value">{{ active_ml_models|default:"0" }}</div>
        <div class="metric-label">AI Systems Active</div>
        <div class="metric-description">ML models deployed</div>
    </div>

    <div class="metric-card" style="--border-color: #ea580c; --icon-color: #ea580c; --icon-bg: #fff7ed;">
        <div class="metric-icon">
            <i class="bi bi-shield-check"></i>
        </div>
        <div class="metric-value">{{ resolution_rate|default:"0" }}%</div>
        <div class="metric-label">Incident Resolution</div>
        <div class="metric-description">Closed incidents rate</div>
    </div>
</div>

<!-- Charts Section -->
<div class="charts-grid">
    <!-- Mission Activity Timeline -->
    <div class="chart-card military-graph full-width">
        <div class="grid-lines"></div>
        <div class="chart-header">
            <div class="chart-title" style="--title-color: #1e40af;">
                <i class="bi bi-graph-up"></i>
                Mission Activity Timeline
            </div>
            <div class="chart-subtitle">Mission creation trends over the last 90 days</div>
        </div>
        <div class="chart-container">
            <canvas id="missionTimelineChart"></canvas>
        </div>
    </div>

    <!-- Threat Intelligence Monitoring -->
    <div class="chart-card military-graph full-width">
        <div class="grid-lines"></div>
        <div class="chart-header">
            <div class="chart-title" style="--title-color: #DC2626;">
                <i class="bi bi-exclamation-diamond"></i>
                Threat Intelligence Monitoring
            </div>
            <div class="chart-subtitle">Threat detection frequency over the last 30 days</div>
        </div>
        <div class="chart-container">
            <canvas id="threatTrendsChart"></canvas>
        </div>
    </div>

    <!-- Mission Status Distribution -->
    <div class="chart-card">
        <div class="chart-header">
            <div class="chart-title" style="--title-color: #15803d;">
                <i class="bi bi-pie-chart-fill"></i>
                Mission Status Distribution
            </div>
        </div>
        <div class="chart-container small">
            <canvas id="missionStatusChart"></canvas>
        </div>
    </div>

    <!-- Threat Severity Analysis -->
    <div class="chart-card">
        <div class="chart-header">
            <div class="chart-title" style="--title-color: #ea580c;">
                <i class="bi bi-shield-exclamation"></i>
                Threat Severity Analysis
            </div>
        </div>
        <div class="chart-container small">
            <canvas id="threatSeverityChart"></canvas>
        </div>
    </div>

    <!-- Branch Deployment -->
    <div class="chart-card">
        <div class="chart-header">
            <div class="chart-title" style="--title-color: #7c3aed;">
                <i class="bi bi-diagram-3-fill"></i>
                Personnel Deployment by Branch
            </div>
        </div>
        <div class="chart-container small">
            <canvas id="branchChart"></canvas>
        </div>
    </div>

    <!-- Incident Priority Levels -->
    <div class="chart-card">
        <div class="chart-header">
            <div class="chart-title" style="--title-color: #D4AF37;">
                <i class="bi bi-exclamation-octagon-fill"></i>
                Incident Priority Distribution
            </div>
        </div>
        <div class="chart-container small">
            <canvas id="incidentPriorityChart"></canvas>
        </div>
    </div>

    <!-- Equipment Inventory -->
    <div class="chart-card military-graph">
        <div class="grid-lines"></div>
        <div class="chart-header">
            <div class="chart-title" style="--title-color: #0F2A4D;">
                <i class="bi bi-box-seam-fill"></i>
                Equipment Inventory by Category
            </div>
        </div>
        <div class="chart-container">
            <canvas id="equipmentCategoryChart"></canvas>
        </div>
    </div>

    <!-- Threat Intelligence Sources -->
    <div class="chart-card military-graph">
        <div class="grid-lines"></div>
        <div class="chart-header">
            <div class="chart-title" style="--title-color: #15803d;">
                <i class="bi bi-broadcast"></i>
                Threat Intelligence Sources
            </div>
        </div>
        <div class="chart-container">
            <canvas id="threatSourceChart"></canvas>
        </div>
    </div>

    <!-- Operational Readiness -->
    <div class="chart-card military-graph">
        <div class="grid-lines"></div>
        <div class="chart-header">
            <div class="chart-title" style="--title-color: #DC2626;">
                <i class="bi bi-radar"></i>
                Operational Readiness Assessment
            </div>
        </div>
        <div class="chart-container">
            <canvas id="readinessRadarChart"></canvas>
        </div>
    </div>

    <!-- Rank Structure -->
    <div class="chart-card">
        <div class="chart-header">
            <div class="chart-title" style="--title-color: #7c3aed;">
                <i class="bi bi-bar-chart-fill"></i>
                Rank Structure Distribution
            </div>
        </div>
        <div class="chart-container">
            <canvas id="rankChart"></canvas>
        </div>
    </div>

    <!-- Security Activity -->
    <div class="chart-card military-graph full-width">
        <div class="grid-lines"></div>
        <div class="chart-header">
            <div class="chart-title" style="--title-color: #ea580c;">
                <i class="bi bi-graph-up-arrow"></i>
                Security Activity Monitoring
            </div>
            <div class="chart-subtitle">Login success and failure rates over the last 30 days</div>
        </div>
        <div class="chart-container">
            <canvas id="loginTrendsChart"></canvas>
        </div>
    </div>
</div>

<!-- High Priority Threats -->
<div class="chart-card" style="margin-bottom: 2.5rem;">
    <div class="chart-header">
        <div class="chart-title" style="--title-color: #DC2626;">
            <i class="bi bi-list-ul"></i>
            High Priority Threats
            <span class="status-badge severity-critical" style="margin-left: auto;">
                {{ high_severity_threats|length }} Active
            </span>
        </div>
    </div>
    {% if high_severity_threats %}
    <div class="data-table-container" style="overflow-x: auto;">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Threat Description</th>
                    <th>Type</th>
                    <th>Severity</th>
                    <th>Location</th>
                    <th>Detection Time</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for threat in high_severity_threats|slice:":10" %}
                <tr>
                    <td>
                        <strong>{{ threat.title|truncatechars:50 }}</strong>
                        {% if threat.description %}
                        <div style="font-size: 0.75rem; color: var(--gray-600); margin-top: 0.25rem;">
                            {{ threat.description|truncatechars:60 }}
                        </div>
                        {% endif %}
                    </td>
                    <td>{{ threat.threat_type }}</td>
                    <td>
                        <span class="severity-badge severity-{{ threat.severity|lower }}">
                            {{ threat.severity }}
                        </span>
                    </td>
                    <td>{{ threat.location|truncatechars:20 }}</td>
                    <td>{{ threat.detected_at|date:"M d H:i" }}</td>
                    <td>{{ threat.status|default:"Monitoring" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <i class="bi bi-check-circle-fill"></i>
        <h3 style="color: var(--gray-700); margin-bottom: 0.5rem;">No Active High Priority Threats</h3>
        <p style="color: var(--gray-600);">All monitored threats are currently at acceptable levels.</p>
    </div>
    {% endif %}
</div>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
    // Military Style Chart Configuration
    const militaryChartConfig = {
        font: {
            family: "'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif",
            size: 12
        },
        color: '#374151',
        borderColor: '#e5e7eb'
    };

    // Apply global chart settings
    Object.assign(Chart.defaults, militaryChartConfig);

    // Military color palette (subdued, professional)
    const militaryColors = {
        navy: '#0F2A4D',
        blue: '#1e40af',
        green: '#15803d',
        gold: '#D4AF37',
        red: '#DC2626',
        purple: '#7c3aed',
        orange: '#ea580c',
        gray: '#6b7280'
    };

    // Severity colors
    const severityColors = {
        'CRITICAL': '#DC2626',
        'HIGH': '#ea580c',
        'MEDIUM': '#f59e0b',
        'LOW': '#15803d'
    };

    // Faded military colors for backgrounds
    const fadedColors = {
        navy: 'rgba(15, 42, 77, 0.1)',
        blue: 'rgba(30, 64, 175, 0.1)',
        green: 'rgba(21, 128, 61, 0.1)',
        red: 'rgba(220, 38, 38, 0.1)',
        gold: 'rgba(212, 175, 55, 0.1)',
        purple: 'rgba(124, 58, 237, 0.1)',
        orange: 'rgba(234, 88, 12, 0.1)'
    };

    // Parse data from Django context with error handling
    function parseData(dataString) {
        try {
            return JSON.parse(dataString || '[]');
        } catch (e) {
            console.warn('Failed to parse data:', dataString);
            return [];
        }
    }

    const missionsTimeline = parseData('{{ missions_timeline|safe|escapejs }}');
    const missionsByStatus = parseData('{{ missions_by_status|safe|escapejs }}');
    const threatTrends = parseData('{{ threat_trends|safe|escapejs }}');
    const threatsBySeverity = parseData('{{ threats_by_severity|safe|escapejs }}');
    const threatsBySource = parseData('{{ threats_by_source|safe|escapejs }}');
    const branchDistribution = parseData('{{ branch_distribution|safe|escapejs }}');
    const rankDistribution = parseData('{{ rank_distribution|safe|escapejs }}');
    const equipmentByCategory = parseData('{{ equipment_by_category|safe|escapejs }}');
    const incidentsByPriority = parseData('{{ incidents_by_priority|safe|escapejs }}');
    const operationalReadiness = parseData('{{ operational_readiness|safe|escapejs }}');
    const loginTrends = parseData('{{ login_trends|safe|escapejs }}');

    // Date formatter for military style (short, precise)
    function formatMilitaryDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    // 1. Mission Timeline Chart
    if (document.getElementById('missionTimelineChart') && missionsTimeline.length) {
        new Chart(document.getElementById('missionTimelineChart'), {
            type: 'line',
            data: {
                labels: missionsTimeline.map(d => formatMilitaryDate(d.date)),
                datasets: [{
                    label: 'Missions Created',
                    data: missionsTimeline.map(d => d.count),
                    borderColor: militaryColors.blue,
                    backgroundColor: fadedColors.blue,
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(0,0,0,0.05)' },
                        ticks: { precision: 0 }
                    },
                    x: {
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    }
                }
            }
        });
    }

    // 2. Threat Trends Chart
    if (document.getElementById('threatTrendsChart') && threatTrends.length) {
        new Chart(document.getElementById('threatTrendsChart'), {
            type: 'line',
            data: {
                labels: threatTrends.map(d => formatMilitaryDate(d.date)),
                datasets: [{
                    label: 'Threats Detected',
                    data: threatTrends.map(d => d.count),
                    borderColor: militaryColors.red,
                    backgroundColor: fadedColors.red,
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    }
                }
            }
        });
    }

    // 3. Mission Status Distribution
    if (document.getElementById('missionStatusChart') && missionsByStatus.length) {
        new Chart(document.getElementById('missionStatusChart'), {
            type: 'doughnut',
            data: {
                labels: missionsByStatus.map(m => m.status),
                datasets: [{
                    data: missionsByStatus.map(m => m.count),
                    backgroundColor: Object.values(militaryColors),
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { padding: 20 }
                    }
                }
            }
        });
    }

    // 4. Threat Severity Analysis
    if (document.getElementById('threatSeverityChart') && threatsBySeverity.length) {
        new Chart(document.getElementById('threatSeverityChart'), {
            type: 'doughnut',
            data: {
                labels: threatsBySeverity.map(t => t.severity),
                datasets: [{
                    data: threatsBySeverity.map(t => t.count),
                    backgroundColor: threatsBySeverity.map(t => severityColors[t.severity] || militaryColors.gray),
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }

    // 5. Branch Deployment
    if (document.getElementById('branchChart') && branchDistribution.length) {
        new Chart(document.getElementById('branchChart'), {
            type: 'doughnut',
            data: {
                labels: branchDistribution.map(b => b.branch),
                datasets: [{
                    data: branchDistribution.map(b => b.count),
                    backgroundColor: [militaryColors.navy, militaryColors.blue, militaryColors.green],
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }

    // 6. Incident Priority Distribution
    if (document.getElementById('incidentPriorityChart') && incidentsByPriority.length) {
        new Chart(document.getElementById('incidentPriorityChart'), {
            type: 'doughnut',
            data: {
                labels: incidentsByPriority.map(i => i.priority),
                datasets: [{
                    data: incidentsByPriority.map(i => i.count),
                    backgroundColor: Object.values(militaryColors),
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }

    // 7. Equipment Inventory
    if (document.getElementById('equipmentCategoryChart') && equipmentByCategory.length) {
        new Chart(document.getElementById('equipmentCategoryChart'), {
            type: 'bar',
            data: {
                labels: equipmentByCategory.map(e => e.category.replace('_', ' ')),
                datasets: [{
                    label: 'Equipment Count',
                    data: equipmentByCategory.map(e => e.count),
                    backgroundColor: militaryColors.navy,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });
    }

    // 8. Threat Sources
    if (document.getElementById('threatSourceChart') && threatsBySource.length) {
        new Chart(document.getElementById('threatSourceChart'), {
            type: 'bar',
            data: {
                labels: threatsBySource.map(t => t.source.replace('_', ' ')),
                datasets: [{
                    label: 'Threat Count',
                    data: threatsBySource.map(t => t.count),
                    backgroundColor: militaryColors.green,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: { legend: { display: false } },
                scales: {
                    x: {
                        beginAtZero: true,
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    },
                    y: {
                        grid: { display: false }
                    }
                }
            }
        });
    }

    // 9. Operational Readiness
    if (document.getElementById('readinessRadarChart') && operationalReadiness) {
        new Chart(document.getElementById('readinessRadarChart'), {
            type: 'radar',
            data: {
                labels: ['Personnel', 'Equipment', 'Missions', 'Intelligence', 'Logistics'],
                datasets: [{
                    label: 'Readiness Score',
                    data: [
                        operationalReadiness.personnel || 0,
                        operationalReadiness.equipment || 0,
                        operationalReadiness.missions || 0,
                        operationalReadiness.intelligence || 0,
                        operationalReadiness.logistics || 0
                    ],
                    backgroundColor: fadedColors.blue,
                    borderColor: militaryColors.blue,
                    borderWidth: 2,
                    pointBackgroundColor: militaryColors.blue,
                    pointBorderColor: '#ffffff',
                    pointHoverRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 100,
                        pointLabels: { font: { size: 11 } },
                        grid: { color: 'rgba(0,0,0,0.1)' }
                    }
                }
            }
        });
    }

    // 10. Rank Structure
    if (document.getElementById('rankChart') && rankDistribution.length) {
        new Chart(document.getElementById('rankChart'), {
            type: 'bar',
            data: {
                labels: rankDistribution.map(r => r.rank),
                datasets: [{
                    label: 'Personnel Count',
                    data: rankDistribution.map(r => r.count),
                    backgroundColor: militaryColors.purple,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { maxRotation: 45 }
                    }
                }
            }
        });
    }

    // 11. Security Activity
    if (document.getElementById('loginTrendsChart') && loginTrends.length) {
        new Chart(document.getElementById('loginTrendsChart'), {
            type: 'line',
            data: {
                labels: loginTrends.map(d => formatMilitaryDate(d.date)),
                datasets: [
                    {
                        label: 'Successful Logins',
                        data: loginTrends.map(d => d.successful || 0),
                        borderColor: militaryColors.green,
                        backgroundColor: fadedColors.green,
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Failed Attempts',
                        data: loginTrends.map(d => d.failed || 0),
                        borderColor: militaryColors.red,
                        backgroundColor: fadedColors.red,
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: { padding: 20 }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    }
                }
            }
        });
    }
</script>
{% endblock %}