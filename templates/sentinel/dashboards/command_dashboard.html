{% extends 'sentinel/admin_base.html' %}

{% block title %}Command Dashboard - KDF SENTINEL{% endblock %}

{% block content %}
<style>
    .dashboard-header {
        background: linear-gradient(135deg, #0F2A4D 0%, #1e40af 100%);
        padding: 30px;
        border-radius: 15px;
        color: white;
        margin-bottom: 30px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .dashboard-header h1 {
        margin: 0 0 10px 0;
        font-size: 32px;
        font-weight: 700;
    }

    .dashboard-header p {
        margin: 0;
        opacity: 0.9;
        font-size: 16px;
    }

    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .metric-card {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
    }

    .metric-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }

    .metric-card.blue { border-left-color: #1e40af; }
    .metric-card.green { border-left-color: #15803d; }
    .metric-card.red { border-left-color: #DC2626; }
    .metric-card.gold { border-left-color: #D4AF37; }
    .metric-card.purple { border-left-color: #7c3aed; }
    .metric-card.orange { border-left-color: #ea580c; }

    .metric-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        margin-bottom: 15px;
    }

    .metric-card.blue .metric-icon { background: rgba(30, 64, 175, 0.1); color: #1e40af; }
    .metric-card.green .metric-icon { background: rgba(21, 128, 61, 0.1); color: #15803d; }
    .metric-card.red .metric-icon { background: rgba(220, 38, 38, 0.1); color: #DC2626; }
    .metric-card.gold .metric-icon { background: rgba(212, 175, 55, 0.1); color: #D4AF37; }
    .metric-card.purple .metric-icon { background: rgba(124, 58, 237, 0.1); color: #7c3aed; }
    .metric-card.orange .metric-icon { background: rgba(234, 88, 12, 0.1); color: #ea580c; }

    .metric-value {
        font-size: 36px;
        font-weight: 700;
        margin: 10px 0;
        color: #1a1a1a;
    }

    .metric-label {
        color: #6b7280;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
    }

    .metric-trend {
        display: flex;
        align-items: center;
        gap: 5px;
        margin-top: 10px;
        font-size: 13px;
    }

    .metric-trend.up { color: #15803d; }
    .metric-trend.down { color: #DC2626; }

    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
    }

    .chart-card {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .chart-card.full-width {
        grid-column: 1 / -1;
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f3f4f6;
    }

    .chart-title {
        font-size: 18px;
        font-weight: 700;
        color: #1a1a1a;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .chart-subtitle {
        font-size: 13px;
        color: #6b7280;
        margin-top: 5px;
    }

    .chart-container {
        position: relative;
        height: 350px;
    }

    .chart-container.small {
        height: 250px;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    .data-table th {
        background: #f9fafb;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #374151;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .data-table td {
        padding: 12px;
        border-bottom: 1px solid #f3f4f6;
        font-size: 14px;
    }

    .data-table tr:hover {
        background: #f9fafb;
    }

    .severity-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        display: inline-block;
    }

    .severity-critical { background: #fee2e2; color: #991b1b; }
    .severity-high { background: #fed7aa; color: #9a3412; }
    .severity-medium { background: #fef3c7; color: #92400e; }
    .severity-low { background: #d1fae5; color: #065f46; }

    .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
        display: inline-block;
    }

    .status-active { background: #d1fae5; color: #065f46; }
    .status-planning { background: #e0e7ff; color: #3730a3; }
    .status-completed { background: #ddd6fe; color: #5b21b6; }

    @media (max-width: 768px) {
        .charts-grid {
            grid-template-columns: 1fr;
        }
        
        .chart-card.full-width {
            grid-column: 1;
        }
    }
</style>

<!-- Dashboard Header -->
<div class="dashboard-header">
    <h1>‚≠ê Command Dashboard</h1>
    <p>Strategic Operations Overview - Kenya Defence Forces</p>
</div>

<!-- Key Metrics Grid -->
<div class="metrics-grid">
    <div class="metric-card blue">
        <div class="metric-icon">
            <i class="bi bi-people-fill"></i>
        </div>
        <div class="metric-value">{{ total_personnel|default:"0" }}</div>
        <div class="metric-label">Active Personnel</div>
    </div>

    <div class="metric-card green">
        <div class="metric-icon">
            <i class="bi bi-crosshair"></i>
        </div>
        <div class="metric-value">{{ active_missions|default:"0" }}</div>
        <div class="metric-label">Active Missions</div>
    </div>

    <div class="metric-card red">
        <div class="metric-icon">
            <i class="bi bi-exclamation-triangle-fill"></i>
        </div>
        <div class="metric-value">{{ critical_threats|default:"0" }}</div>
        <div class="metric-label">Critical Threats</div>
    </div>

    <div class="metric-card gold">
        <div class="metric-icon">
            <i class="bi bi-currency-dollar"></i>
        </div>
        <div class="metric-value">KES {{ total_budget_allocated|floatformat:0|default:"0" }}M</div>
        <div class="metric-label">Budget Allocated</div>
    </div>

    <div class="metric-card purple">
        <div class="metric-icon">
            <i class="bi bi-cpu-fill"></i>
        </div>
        <div class="metric-value">{{ active_ml_models|default:"0" }}</div>
        <div class="metric-label">Active ML Models</div>
    </div>

    <div class="metric-card orange">
        <div class="metric-icon">
            <i class="bi bi-shield-check"></i>
        </div>
        <div class="metric-value">{{ resolution_rate|default:"0" }}%</div>
        <div class="metric-label">Incident Resolution</div>
    </div>
</div>

<!-- Charts Section -->
<div class="charts-grid">
    <!-- Mission Timeline (Line Chart) -->
    <div class="chart-card full-width">
        <div class="chart-header">
            <div>
                <div class="chart-title">
                    <i class="bi bi-graph-up" style="color: #1e40af;"></i>
                    Mission Activity Timeline
                </div>
                <div class="chart-subtitle">Last 90 days mission creation trends</div>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="missionTimelineChart"></canvas>
        </div>
    </div>

    <!-- Threat Intelligence Trends (Line Chart) -->
    <div class="chart-card full-width">
        <div class="chart-header">
            <div>
                <div class="chart-title">
                    <i class="bi bi-exclamation-diamond" style="color: #DC2626;"></i>
                    Threat Detection Trends
                </div>
                <div class="chart-subtitle">30-day threat intelligence monitoring</div>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="threatTrendsChart"></canvas>
        </div>
    </div>

    <!-- Mission Status Distribution (Donut Chart) -->
    <div class="chart-card">
        <div class="chart-header">
            <div>
                <div class="chart-title">
                    <i class="bi bi-pie-chart-fill" style="color: #15803d;"></i>
                    Mission Status Distribution
                </div>
            </div>
        </div>
        <div class="chart-container small">
            <canvas id="missionStatusChart"></canvas>
        </div>
    </div>

    <!-- Threat Severity Distribution (Donut Chart) -->
    <div class="chart-card">
        <div class="chart-header">
            <div>
                <div class="chart-title">
                    <i class="bi bi-shield-exclamation" style="color: #ea580c;"></i>
                    Threat Severity Levels
                </div>
            </div>
        </div>
        <div class="chart-container small">
            <canvas id="threatSeverityChart"></canvas>
        </div>
    </div>

    <!-- Branch Distribution (Donut Chart) -->
    <div class="chart-card">
        <div class="chart-header">
            <div>
                <div class="chart-title">
                    <i class="bi bi-diagram-3-fill" style="color: #7c3aed;"></i>
                    Personnel by Branch
                </div>
            </div>
        </div>
        <div class="chart-container small">
            <canvas id="branchChart"></canvas>
        </div>
    </div>

    <!-- Incident Priority (Donut Chart) -->
    <div class="chart-card">
        <div class="chart-header">
            <div>
                <div class="chart-title">
                    <i class="bi bi-exclamation-octagon-fill" style="color: #D4AF37;"></i>
                    Incident Priority Levels
                </div>
            </div>
        </div>
        <div class="chart-container small">
            <canvas id="incidentPriorityChart"></canvas>
        </div>
    </div>

    <!-- Equipment by Category (Bar Chart) -->
    <div class="chart-card">
        <div class="chart-header">
            <div>
                <div class="chart-title">
                    <i class="bi bi-box-seam-fill" style="color: #1e40af;"></i>
                    Equipment by Category
                </div>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="equipmentCategoryChart"></canvas>
        </div>
    </div>

    <!-- Threat Sources (Bar Chart) -->
    <div class="chart-card">
        <div class="chart-header">
            <div>
                <div class="chart-title">
                    <i class="bi bi-broadcast" style="color: #15803d;"></i>
                    Threat Intelligence Sources
                </div>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="threatSourceChart"></canvas>
        </div>
    </div>

    <!-- Operational Readiness (Radar Chart) -->
    <div class="chart-card">
        <div class="chart-header">
            <div>
                <div class="chart-title">
                    <i class="bi bi-radar" style="color: #DC2626;"></i>
                    Operational Readiness Score
                </div>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="readinessRadarChart"></canvas>
        </div>
    </div>

    <!-- Rank Distribution (Bar Chart) -->
    <div class="chart-card">
        <div class="chart-header">
            <div>
                <div class="chart-title">
                    <i class="bi bi-bar-chart-fill" style="color: #7c3aed;"></i>
                    Personnel Rank Distribution
                </div>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="rankChart"></canvas>
        </div>
    </div>

    <!-- Login Activity (Line Chart) -->
    <div class="chart-card full-width">
        <div class="chart-header">
            <div>
                <div class="chart-title">
                    <i class="bi bi-graph-up-arrow" style="color: #ea580c;"></i>
                    Login Activity Monitoring
                </div>
                <div class="chart-subtitle">Successful vs Failed login attempts - Last 30 days</div>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="loginTrendsChart"></canvas>
        </div>
    </div>
</div>

<!-- Recent Threats Table -->
<div class="chart-card" style="margin-bottom: 30px;">
    <div class="chart-header">
        <div>
            <div class="chart-title">
                <i class="bi bi-list-ul" style="color: #DC2626;"></i>
                High Priority Threats
            </div>
        </div>
    </div>
    <table class="data-table">
        <thead>
            <tr>
                <th>Threat</th>
                <th>Type</th>
                <th>Severity</th>
                <th>Location</th>
                <th>Detected</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for threat in high_severity_threats %}
            <tr>
                <td><strong>{{ threat.title }}</strong></td>
                <td>{{ threat.threat_type }}</td>
                <td>
                    <span class="severity-badge severity-{{ threat.severity|lower }}">
                        {{ threat.severity }}
                    </span>
                </td>
                <td>{{ threat.location }}</td>
                <td>{{ threat.detected_at|date:"M d, Y H:i" }}</td>
                <td>{{ threat.status }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6" style="text-align: center; padding: 30px; color: #6b7280;">
                    No high priority threats detected
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
    // Parse data from Django context
    const missionsTimeline = JSON.parse('{{ missions_timeline|safe }}');
    const missionsByStatus = JSON.parse('{{ missions_by_status|safe }}');
    const threatTrends = JSON.parse('{{ threat_trends|safe }}');
    const threatsBySeverity = JSON.parse('{{ threats_by_severity|safe }}');
    const threatsBySource = JSON.parse('{{ threats_by_source|safe }}');
    const branchDistribution = JSON.parse('{{ branch_distribution|safe }}');
    const rankDistribution = JSON.parse('{{ rank_distribution|safe }}');
    const equipmentByCategory = JSON.parse('{{ equipment_by_category|safe }}');
    const incidentsByPriority = JSON.parse('{{ incidents_by_priority|safe }}');
    const operationalReadiness = JSON.parse('{{ operational_readiness|safe }}');
    const loginTrends = JSON.parse('{{ login_trends|safe }}');

    // Chart.js Default Settings
    Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
    Chart.defaults.color = '#6b7280';

    // Color Palettes
    const kdfColors = ['#0F2A4D', '#1e40af', '#15803d', '#D4AF37', '#DC2626', '#7c3aed', '#ea580c'];
    const severityColors = {
        'CRITICAL': '#DC2626',
        'HIGH': '#ea580c',
        'MEDIUM': '#f59e0b',
        'LOW': '#15803d'
    };

    // 1. Mission Timeline Chart (Line)
    new Chart(document.getElementById('missionTimelineChart'), {
        type: 'line',
        data: {
            labels: missionsTimeline.map(d => new Date(d.date).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})),
            datasets: [{
                label: 'Missions Created',
                data: missionsTimeline.map(d => d.count),
                borderColor: '#1e40af',
                backgroundColor: 'rgba(30, 64, 175, 0.1)',
                tension: 0.4,
                fill: true,
                borderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true, ticks: { precision: 0 } }
            }
        }
    });

    // 2. Threat Trends Chart (Line)
    new Chart(document.getElementById('threatTrendsChart'), {
        type: 'line',
        data: {
            labels: threatTrends.map(d => new Date(d.date).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})),
            datasets: [{
                label: 'Threats Detected',
                data: threatTrends.map(d => d.count),
                borderColor: '#DC2626',
                backgroundColor: 'rgba(220, 38, 38, 0.1)',
                tension: 0.4,
                fill: true,
                borderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true, ticks: { precision: 0 } }
            }
        }
    });

    // 3. Mission Status Donut Chart
    new Chart(document.getElementById('missionStatusChart'), {
        type: 'doughnut',
        data: {
            labels: missionsByStatus.map(m => m.status),
            datasets: [{
                data: missionsByStatus.map(m => m.count),
                backgroundColor: kdfColors,
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });

    // 4. Threat Severity Donut Chart
    new Chart(document.getElementById('threatSeverityChart'), {
        type: 'doughnut',
        data: {
            labels: threatsBySeverity.map(t => t.severity),
            datasets: [{
                data: threatsBySeverity.map(t => t.count),
                backgroundColor: threatsBySeverity.map(t => severityColors[t.severity] || '#6b7280'),
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });

    // 5. Branch Distribution Donut Chart
    new Chart(document.getElementById('branchChart'), {
        type: 'doughnut',
        data: {
            labels: branchDistribution.map(b => b.branch),
            datasets: [{
                data: branchDistribution.map(b => b.count),
                backgroundColor: ['#0F2A4D', '#1e40af', '#15803d'],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });

    // 6. Incident Priority Donut Chart
    new Chart(document.getElementById('incidentPriorityChart'), {
        type: 'doughnut',
        data: {
            labels: incidentsByPriority.map(i => i.priority),
            datasets: [{
                data: incidentsByPriority.map(i => i.count),
                backgroundColor: kdfColors,
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });

    // 7. Equipment Category Bar Chart
    new Chart(document.getElementById('equipmentCategoryChart'), {
        type: 'bar',
        data: {
            labels: equipmentByCategory.map(e => e.category),
            datasets: [{
                label: 'Count',
                data: equipmentByCategory.map(e => e.count),
                backgroundColor: '#1e40af',
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

    // 8. Threat Source Bar Chart
    new Chart(document.getElementById('threatSourceChart'), {
        type: 'bar',
        data: {
            labels: threatsBySource.map(t => t.source),
            datasets: [{
                label: 'Threats',
                data: threatsBySource.map(t => t.count),
                backgroundColor: '#15803d',
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: { beginAtZero: true }
            }
        }
    });

    // 9. Operational Readiness Radar Chart
    new Chart(document.getElementById('readinessRadarChart'), {
        type: 'radar',
        data: {
            labels: ['Personnel', 'Equipment', 'Missions', 'Intelligence', 'Logistics'],
            datasets: [{
                label: 'Readiness Score',
                data: [
                    operationalReadiness.personnel,
                    operationalReadiness.equipment,
                    operationalReadiness.missions,
                    operationalReadiness.intelligence,
                    operationalReadiness.logistics
                ],
                backgroundColor: 'rgba(30, 64, 175, 0.2)',
                borderColor: '#1e40af',
                borderWidth: 2,
                pointBackgroundColor: '#1e40af',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: '#1e40af'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });

    // 10. Rank Distribution Bar Chart
    new Chart(document.getElementById('rankChart'), {
        type: 'bar',
        data: {
            labels: rankDistribution.map(r => r.rank),
            datasets: [{
                label: 'Personnel',
                data: rankDistribution.map(r => r.count),
                backgroundColor: '#7c3aed',
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

    // 11. Login Trends Chart
    new Chart(document.getElementById('loginTrendsChart'), {
        type: 'line',
        data: {
            labels: loginTrends.map(d => new Date(d.date).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})),
            datasets: [
                {
                    label: 'Successful Logins',
                    data: loginTrends.map(d => d.successful),
                    borderColor: '#15803d',
                    backgroundColor: 'rgba(21, 128, 61, 0.1)',
                    tension: 0.4,
                    fill: true,
                    borderWidth: 3
                },
                {
                    label: 'Failed Logins',
                    data: loginTrends.map(d => d.failed),
                    borderColor: '#DC2626',
                    backgroundColor: 'rgba(220, 38, 38, 0.1)',
                    tension: 0.4,
                    fill: true,
                    borderWidth: 3
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' }
            },
            scales: {
                y: { beginAtZero: true, ticks: { precision: 0 } }
            }
        }
    });
</script>
{% endblock %}